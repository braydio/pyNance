<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finance Dashroad</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    /* General Styles */
    body {
      background-color: #121212; /* Gunmetal-inspired dark background */
      font-family: "JetBrains Mono", monospace;
      color: #d1d1d1; /* Metallic light gray text */
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 2rem;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
      color: #a0aec0; /* Metallic steel blue */
      text-transform: uppercase;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      color: #718096; /* Soft metallic gray */
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* Table Styles */
    table {
      width: 90%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      background: #1a1a1a; /* Deep gunmetal */
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    thead {
      background: #2d2d2d; /* Dark metallic */
    }

    thead th {
      padding: 1rem;
      font-weight: bold;
      color: #d1d1d1; /* Metallic text */
      text-align: left;
    }

    tbody tr:nth-child(odd) {
      background: #1e1e1e; /* Slightly lighter gunmetal */
    }

    tbody tr:nth-child(even) {
      background: #242424; /* Even row for subtle contrast */
    }

    tbody td {
      padding: 0.75rem 1rem;
      color: #a0aec0; /* Light metallic gray */
    }

    tbody td.negative {
      color: #e53e3e; /* Sleek metallic red for negative values */
    }

    tbody td.positive {
      color: #38a169; /* Metallic green for positive values */
    }

    /* Button Styles */
    button {
      background-color: #2d3748; /* Dark metallic steel */
      color: #d1d1d1; /* Light metallic text */
      padding: 0.75rem 1.5rem;
      border: 1px solid #4a5568; /* Subtle metallic border */
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      text-transform: uppercase;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    button:hover {
      background-color: #4a5568; /* Lighter metallic steel */
      border-color: #a0aec0;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
    }

    button:active {
      background-color: #718096; /* Metallic gray when active */
    }

    #status {
      margin-top: 1rem;
      font-size: 1rem;
      text-align: center;
    }

    #status.success {
      color: #38a169; /* Positive status green */
    }

    #status.error {
      color: #e53e3e; /* Negative status red */
    }
  </style>
</head>
<body>
  <h1>Finance Dashroad</h1>
  <h2>Link Your Bank Account</h2>
  <button id="link-button">Link Account</button>
  <p id="status"></p>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="transactions-table">
      <tr>
        <td colspan="3" style="text-align: center; color: #718096;">No data available</td>
      </tr>
    </tbody>
  </table>

  <button onclick="processTransactions()">Process Transactions</button>

  <script>
    // Fetch the link token from the Flask backend
    fetch('/get_link_token')
      .then(response => response.json())
      .then(data => {
        if (data.link_token) {
          const handler = Plaid.create({
            token: data.link_token,
            onSuccess: function(public_token, metadata) {
              console.log("Public Token:", public_token);

              // Save the public token and automatically get the access token
              fetch('/save_public_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ public_token: public_token })
              }).then(response => response.json())
                .then(data => {
                  const status = document.getElementById("status");
                  if (data.access_token) {
                    console.log("Access Token:", data.access_token);
                    status.textContent = "Access token received!";
                    status.classList.add("success");
                  } else {
                    console.error("Error:", data.error);
                    status.textContent = "Failed to get access token.";
                    status.classList.add("error");
                  }
                });
            },
            onExit: function(err, metadata) {
              const status = document.getElementById("status");
              if (err) {
                console.error("Error during exit:", err);
                status.textContent = "User exited with an error.";
                status.classList.add("error");
              } else {
                console.log("User exited without error.");
                status.textContent = "User exited without error.";
                status.classList.add("success");
              }
            }
          });

          document.getElementById("link-button").onclick = function() {
            handler.open();
          };

        } else {
          const status = document.getElementById("status");
          status.textContent = "Error fetching link token: " + data.error;
          status.classList.add("error");
        }
      })
      .catch(error => {
        console.error("Error fetching link token:", error);
        const status = document.getElementById("status");
        status.textContent = "Error fetching link token.";
        status.classList.add("error");
      });

    // Fetch transactions and populate the table
    function fetchTransactions() {
      fetch('/get_transactions')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.getElementById('transactions-table');
          tableBody.innerHTML = ""; // Clear previous rows
          if (data.status === "success") {
            data.data.forEach(transaction => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${transaction.date}</td>
                <td>${transaction.name}</td>
                <td class="${transaction.amount < 0 ? 'negative' : 'positive'}">
                  ${transaction.amount.toFixed(2)}
                </td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            console.error("Error fetching transactions:", data.message);
          }
        })
        .catch(error => console.error("Fetch error:", error));
    }

    // Process transactions
    function processTransactions() {
      fetch('/process_transactions', {
        method: 'POST',
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            console.log("Transactions processed:", data.message);
            alert("Transactions processed successfully!");
            fetchTransactions();
          } else {
            console.error("Error processing transactions:", data.message);
            alert("Error processing transactions.");
          }
        })
        .catch(error => console.error("Fetch error:", error));
    }

    // Automatically fetch transactions on page load
    document.addEventListener('DOMContentLoaded', fetchTransactions);
  </script>
</body>
</html>
