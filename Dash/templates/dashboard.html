<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Dashroad</title>
  <link
    rel="stylesheet"
    id="current-theme"
    href="{{ url_for('static', filename='themes/' + current_theme) }}"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
</head>
<body>
  <header>
    <div>
      <h1>Brayden.com</h1>
      <h3>Finance</h3>
    </div>
    <nav class="menu">
      <button onclick="window.location.href='/'">Dashboard</button>
      <button onclick="window.location.href='/accounts'">Accounts</button>
      <button onclick="window.location.href='/transactions'">Transactions</button>
      <button onclick="window.location.href='/settings'">Settings</button>
    </nav>
  </header>
  <main>
    <!-- Main Visualization Area -->
    <div class="visualization">
      <div class="chart-cashflow">
        <h2>Net Income vs Spending</h2>
        <button id="toggleCashFlowChart">Toggle Chart</button>
        <canvas id="cashFlowChart"></canvas>
      </div>

      <div class="chart-categories">
        <h2>Spending by Category</h2>
        <button id="toggleCategoryChart">Toggle Chart</button>
        <canvas id="categoryBreakdownChart"></canvas>
      </div>

      <div class="chart-networth">
        <h2>Net Worth Over Time</h2>
        <button id="toggleNetWorthView">Toggle (Line / Area)</button>
        <canvas id="netWorthChart"></canvas>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="transactions">
      <h3>Transactions</h3>
      <table id="transactions-table" class="display">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Name</th>
            <th>Category</th>
            <th>Merchant</th>
            <th>Account</th>
            <th>Institution</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="7">No transactions available</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <footer>&copy; This is fine. I'm fine.</footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.4/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.4/js/buttons.html5.min.js"></script>

  <!-- Finance Dashboard Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Generic fetch helper
      async function fetchData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error(`HTTP error! Status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error(`Error fetching data from ${url}:`, error);
          throw error;
        }
      }

      /**
       * Transactions Table Setup
       */
      const transactionsTable = document.querySelector("#transactions-table");
      if (transactionsTable) {
        try {
          const { status, data } = await fetchData("/get_transactions");
          if (status === "success") {
            const tableBody = transactionsTable.querySelector("tbody");
            tableBody.innerHTML = data.transactions
              .map(
                (tx) => `
                  <tr>
                    <td>${tx.date || "N/A"}</td>
                    <td>${tx.amount || "N/A"}</td>
                    <td>${tx.name || "N/A"}</td>
                    <td>${tx.category || "Uncategorized"}</td>
                    <td>${tx.merchant_name || "Unknown"}</td>
                    <td>${tx.account_name || "Unknown Account"}</td>
                    <td>${tx.institution_name || "Unknown Institution"}</td>
                  </tr>
                `
              )
              .join("");

            // Initialize DataTables
            $(transactionsTable).DataTable({
              pageLength: 20,
              ordering: true,
              dom: "Bfrtip",
              buttons: ["csv", "excel"],
            });
          }
        } catch (error) {
          console.error("Error initializing transactions table:", error);
          transactionsTable.querySelector(
            "tbody"
          ).innerHTML = `<tr><td colspan="7">Error loading transactions.</td></tr>`;
        }
      }

      /**
       * Category Breakdown Chart (Pie <-> Bar Toggle)
       */
      const categoryCtx = document
        .getElementById("categoryBreakdownChart")
        ?.getContext("2d");
      const toggleCategoryChartBtn = document.getElementById(
        "toggleCategoryChart"
      );
      let categoryChart;
      let isCategoryPie = true;

      async function renderCategoryChart() {
        if (!categoryCtx) return;
        try {
          const { status, data } = await fetchData("/api/category_breakdown");
          if (status !== "success") return;

          const totalSpending = data.reduce((sum, entry) => sum + entry.amount, 0);
          const percentages = data.map((entry) => {
            return ((entry.amount / totalSpending) * 100).toFixed(2);
          });
          const values = data.map((entry) => Math.round(entry.amount));
          const labels = data.map((entry) => entry.category);

          // Sort data for bar chart in descending order of spending
          const sortedData = [...data].sort((a, b) => b.amount - a.amount);
          const sortedLabels = sortedData.map((entry) => entry.category);
          const sortedValues = sortedData.map((entry) => Math.round(entry.amount));

          if (categoryChart) categoryChart.destroy();

          categoryChart = new Chart(categoryCtx, {
            type: isCategoryPie ? "pie" : "bar",
            data: {
              labels: isCategoryPie ? labels : sortedLabels,
              datasets: [
                {
                  label: isCategoryPie
                    ? "Spending by Category (%)"
                    : "Spending by Category ($)",
                  data: isCategoryPie ? percentages : sortedValues,
                  backgroundColor: [
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                    "#FF9F40",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true },
                tooltip: {
                  callbacks: {
                    label: (context) =>
                      isCategoryPie
                        ? `${context.label}: ${context.raw}%`
                        : `${context.label}: $${context.raw.toLocaleString()}`,
                  },
                },
              },
              ...(isCategoryPie
                ? {}
                : {
                    indexAxis: "y",
                    scales: {
                      x: { beginAtZero: true },
                    },
                  }),
            },
          });
        } catch (error) {
          console.error("Error rendering category chart:", error);
        }
      }

      if (toggleCategoryChartBtn) {
        toggleCategoryChartBtn.addEventListener("click", () => {
          isCategoryPie = !isCategoryPie;
          renderCategoryChart();
        });
      }
      await renderCategoryChart();

      /**
       * Cash Flow Chart (Stacked vs. Net Income Toggle)
       */
      const cashFlowCtx = document.getElementById("cashFlowChart")?.getContext("2d");
      const toggleCashFlowChartBtn = document.getElementById("toggleCashFlowChart");
      let cashFlowChart;
      let isStackedView = true; // Default is stacked income & expense

      async function renderCashFlowChart() {
        if (!cashFlowCtx) return;
        try {
          const { status, data } = await fetchData("/api/cash_flow");
          if (status !== "success") return;

          const labels = data.map((entry) => entry.month);
          const incomeData = data.map((entry) => Math.round(entry.income));
          // Expenses are negative, to show on a stacked bar
          const expenseData = data.map((entry) => -Math.round(entry.expenses));
          // Net = income + negative expenses
          const netData = incomeData.map((value, index) => value + expenseData[index]);

          // Destroy existing chart if it exists
          if (cashFlowChart) cashFlowChart.destroy();

          const datasets = isStackedView
            ? [
                {
                  label: "Income",
                  data: incomeData,
                  backgroundColor: "#4BC0C0",
                },
                {
                  label: "Expenses",
                  data: expenseData,
                  backgroundColor: "#FF6384",
                },
              ]
            : [
                {
                  label: "Net Income",
                  data: netData,
                  backgroundColor: netData.map((val) => (val >= 0 ? "#4BC0C0" : "#FF6384")),
                },
              ];

          cashFlowChart = new Chart(cashFlowCtx, {
            type: "bar",
            data: {
              labels,
              datasets,
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      if (isStackedView) {
                        return `${context.dataset.label}: $${context.raw.toLocaleString()}`;
                      } else {
                        return `Net Income: $${context.raw.toLocaleString()}`;
                      }
                    },
                  },
                },
                datalabels: {
                  anchor: "end",
                  align: "top",
                  formatter: (value) => `$${value.toLocaleString()}`,
                  color: "#000",
                  font: {
                    weight: "bold",
                  },
                },
              },
              scales: {
                x: {
                  stacked: isStackedView,
                  ticks: { autoSkip: false },
                },
                y: {
                  stacked: isStackedView,
                  beginAtZero: true,
                  ticks: {
                    callback: (value) => `$${value.toLocaleString()}`,
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error rendering cash flow chart:", error);
        }
      }

      if (toggleCashFlowChartBtn) {
        toggleCashFlowChartBtn.addEventListener("click", () => {
          isStackedView = !isStackedView;
          renderCashFlowChart();
        });
      }
      await renderCashFlowChart();

      /**
       * Net Worth Chart (Line / Stacked Area Toggle)
       */
      const netWorthCtx = document.getElementById("netWorthChart")?.getContext("2d");
      const toggleNetWorthViewBtn = document.getElementById("toggleNetWorthView");
      let netWorthChart;
      let useAreaChart = false; // switch between line and area chart

      async function renderNetWorthChart() {
        if (!netWorthCtx) return;
        try {
          // Example endpoint, adjust to your actual data source
          // Should return an array of objects with { date, netWorth }
          const { status, data } = await fetchData("/api/net_worth");
          if (status !== "success") return;

          // Sort by date if not sorted
          const sortedData = data.sort(
            (a, b) => new Date(a.date) - new Date(b.date)
          );
          const labels = sortedData.map((entry) => entry.date);
          const netWorthValues = sortedData.map((entry) => entry.netWorth);

          // Clean up existing chart
          if (netWorthChart) netWorthChart.destroy();

          netWorthChart = new Chart(netWorthCtx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Net Worth",
                  data: netWorthValues,
                  fill: useAreaChart,
                  borderColor: "#36A2EB",
                  backgroundColor: useAreaChart ? "rgba(54, 162, 235, 0.3)" : "transparent",
                  tension: 0.2,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => `Net Worth: $${context.raw.toLocaleString()}`,
                  },
                },
              },
              scales: {
                x: {
                  ticks: {
                    autoSkip: true,
                    maxRotation: 0,
                  },
                },
                y: {
                  beginAtZero: false,
                  ticks: {
                    callback: (value) => `$${value.toLocaleString()}`,
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error rendering net worth chart:", error);
        }
      }

      if (toggleNetWorthViewBtn) {
        toggleNetWorthViewBtn.addEventListener("click", () => {
          useAreaChart = !useAreaChart;
          renderNetWorthChart();
        });
      }

      // Initial load of net worth chart
      await renderNetWorthChart();
    });
  </script>
</body>
</html>
